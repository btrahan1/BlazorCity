@inject BlazorCity.Services.GameSettings Settings
@inject BlazorCity.Services.CityState CityState
@inject Microsoft.JSInterop.IJSRuntime JS

<div class="settings-modal" style="@(IsVisible ? "display:flex" : "display:none")">
    <div class="settings-content">
        <h2>City Configuration</h2>
        
        <div class="setting-group">
            <label>Tick Speed (ms): @Settings.TickSpeedMs</label>
            <input type="range" min="100" max="5000" step="100" @bind="Settings.TickSpeedMs" @bind:after="NotifyChange" />
            <small>(Lower is faster)</small>
        </div>

        <div class="setting-group">
            <label>Grid Size: @Settings.GridSize</label>
            <input type="number" @bind="Settings.GridSize" />
            <button class="btn btn-warning btn-sm" @onclick="ReloadPage">Apply & Restart</button>
        </div>

        <hr />

        <div class="setting-group">
            <label>Residential Tax/Sim: ¬ß@Settings.ResidentialTaxPerEsim</label>
            <input type="number" step="1" @bind="Settings.ResidentialTaxPerEsim" @bind:after="NotifyChange" />
        </div>

        <div class="setting-group">
            <h4>üìä Economics & Stats</h4>
            <div class="tabs">
                <button class="@(activeTab == "cost" ? "active" : "")" @onclick="@(() => activeTab = "cost")">Build Cost</button>
                <button class="@(activeTab == "revenue" ? "active" : "")" @onclick="@(() => activeTab = "revenue")">Revenue</button>
                <button class="@(activeTab == "upkeep" ? "active" : "")" @onclick="@(() => activeTab = "upkeep")">Upkeep</button>
                <button class="@(activeTab == "pop" ? "active" : "")" @onclick="@(() => activeTab = "pop")">Population</button>
            </div>

            <div class="scroll-box">
                @if (activeTab == "cost")
                {
                    <p class="hint">One-time cost to build (¬ß)</p>
                    @foreach(var item in Settings.BuildingCosts)
                    {
                        <div class="row">
                            <span>@item.Key</span>
                            <input type="number" value="@item.Value" @onchange="@((ChangeEventArgs e) => UpdateDict(Settings.BuildingCosts, item.Key, e))" />
                        </div>
                    }
                }
                @if (activeTab == "revenue")
                {
                    <p class="hint">Monthly Income from Taxes based on connectivity (¬ß/mo)</p>
                    @foreach(var item in Settings.BuildingRevenue)
                    {
                        <div class="row">
                            <span>@item.Key</span>
                            <input type="number" value="@item.Value" @onchange="@((ChangeEventArgs e) => UpdateDict(Settings.BuildingRevenue, item.Key, e))" />
                        </div>
                    }
                }
                @if (activeTab == "upkeep")
                {
                    <p class="hint">Monthly Maintenance Cost (¬ß/mo)</p>
                    @foreach(var item in Settings.BuildingUpkeep)
                    {
                        <div class="row">
                            <span>@item.Key</span>
                            <input type="number" value="@item.Value" @onchange="@((ChangeEventArgs e) => UpdateDict(Settings.BuildingUpkeep, item.Key, e))" />
                        </div>
                    }
                }
                @if (activeTab == "pop")
                {
                    <p class="hint">Residents per building</p>
                    @foreach(var item in Settings.BuildingPopulation)
                    {
                        <div class="row">
                            <span>@item.Key</span>
                            <input type="number" value="@item.Value" @onchange="@((ChangeEventArgs e) => UpdateDictInt(Settings.BuildingPopulation, item.Key, e))" />
                        </div>
                    }
                }
            </div>
        </div>

        <hr />

        <div class="actions">
            <button class="btn btn-primary" @onclick="SaveGame">üíæ Save Game</button>
             <button class="btn btn-danger" @onclick="ClearSave">üóëÔ∏è Wipe Save</button>
            <button class="btn btn-secondary" @onclick="Close">Close</button>
        </div>
    </div>
</div>

<style>
    .settings-modal {
        position: fixed;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.6);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
        pointer-events: auto;
    }
    .settings-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        width: 450px;
        max-width: 95vw;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        font-family: 'Segoe UI', sans-serif;
    }
    .setting-group { margin-bottom: 20px; }
    .setting-group label { display: block; font-weight: bold; margin-bottom: 5px; }
    .setting-group input[type=range], .setting-group input[type=number] { width: 100%; padding: 5px; }
    
    .tabs { display: flex; gap: 5px; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; overflow-x: auto; }
    .tabs button {
        background: none; border: none; padding: 5px 10px; cursor: pointer; font-weight: bold; color: #666; width: auto; white-space: nowrap;
    }
    .tabs button.active { color: #007bff; border-bottom: 2px solid #007bff; margin-bottom: -7px; }

    .scroll-box { max-height: 250px; overflow-y: auto; border: 1px solid #eee; padding: 10px; background: #fafafa; border-radius: 4px; }
    .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .row span { font-weight: 500; }
    .row input { width: 100px; padding: 4px; border: 1px solid #ccc; border-radius: 3px; }
    .hint { font-size: 0.85rem; color: #666; margin-bottom: 8px; font-style: italic; }
    
    .actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; flex-wrap: wrap; }
    .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; }
    .btn-primary { background: #007bff; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-warning { background: #ffc107; color: black; }
</style>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }

    private string activeTab = "cost";

    private void NotifyChange() => Settings.NotifyChanged();

    private void UpdateDict(Dictionary<string, decimal> dict, string key, ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString(), out decimal val))
        {
            dict[key] = val;
            NotifyChange();
        }
    }

    private void UpdateDictInt(Dictionary<string, int> dict, string key, ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int val))
        {
            dict[key] = val;
            NotifyChange();
        }
    }

    private void Close() {
        IsVisible = false;
        IsVisibleChanged.InvokeAsync(false);
    }

    private void ReloadPage() {
        JS.InvokeVoidAsync("location.reload");
    }

    // Persistence Logic (Simple JSON Dump)
    private async Task SaveGame()
    {
        var data = new
        {
            Funds = CityState.Funds,
            Pop = CityState.Population, // Just snapshot
            Time = CityState.GameTime,
            Buildings = CityState.PlacedBuildings,
            Settings = Settings
        };
        
        var json = System.Text.Json.JsonSerializer.Serialize(data);
        await JS.InvokeVoidAsync("localStorage.setItem", "BlazorCitySave", json);
        await JS.InvokeVoidAsync("alert", "Game Saved!");
    }

    private async Task ClearSave()
    {
        await JS.InvokeVoidAsync("localStorage.removeItem", "BlazorCitySave");
        ReloadPage();
    }
}
